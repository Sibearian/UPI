<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPI</title>
    <script>
      const state = {
        upi: null,
        scanned: true,
      };
      const UPI_URI_START = "upi://pay?";

      function scanAgain() {
        state.scanned = false;
      }
    </script>
  </head>
  <body>
    <video id="stream" style="width: 75vw; height: 75vh">Why</video>
    <button type="button" onclick="scanAgain()">Scan Again</button>
    <div id="error"></div>
    <div id="output"></div>
    <div><ul id="logs"></ul></div>
    <script>
      /**
       * @type {HTMLVideoElement}
       */
      let video = document.querySelector("#stream");
      /**
       * @type {HTMLDivElement}
       */
      let error = document.querySelector("#error");
      /**
       * @type {HTMLDivElement}
       */
      let output = document.querySelector("#output");

      // function logger(string) {
      //   log.innerHTML += `<li>${string}</li>`;
      // }

      function checkRequirements() {
        if (!navigator.mediaDevices?.getUserMedia) {
          throw "no media devices api";
        }

        if (!("BarcodeDetector" in globalThis)) {
          throw "Barcode Detector is not supported by this browser.";
        }

        return true;
      }

      function setup() {
        const stream = navigator.mediaDevices
          .getUserMedia({
            video: { facingMode: { ideal: "environment" } },
            audio: false,
          })
          .then((stream) => {
            video.srcObject = stream;
            video.play();
            scanAgain();
          });
      }

      const barcodeDetector = new BarcodeDetector({
        formats: ["qr_code"],
      });

      setInterval(async () => {
        if (state.scanned) return;
        try {
          const barcodes = await barcodeDetector.detect(video);
          let url = "";
          for (let i = 0; i < barcodes.length; i++) {
            url = barcodes[i].rawValue;
            if (!url.startsWith(UPI_URI_START)) continue;

            const temp = new URL(url);
            if (!(temp.searchParams.has("pa") && temp.searchParams.has("pn")))
              return;

            state.upi = temp;
            state.scanned = true;

            output.innerText = temp.href;
          }
        } catch (err) {
          error.innerText = err;
        }
      }, 100);
    </script>
  </body>
</html>
