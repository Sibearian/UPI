<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPI</title>
    <script src="https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.9.15/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@undecaf/barcode-detector-polyfill@0.9.20/dist/index.js"></script>
    <script>
      try {
        window["BarcodeDetector"].getSupportedFormats();
      } catch {
        window["BarcodeDetector"] =
          barcodeDetectorPolyfill.BarcodeDetectorPolyfill;
      }

      const state = {
        upi: null,
        scanned: true,
      };

      function scanAgain() {
        state.scanned = false;
      }
    </script>
  </head>
  <body>
    <video id="stream" style="width: 75vw; height: 75vh">Why</video>
    <button type="button" onclick="scanAgain()">Scan Again</button>
    <div>
      <h1>Output</h1>
      <div id="output"></div>
    </div>
    <div>
      <h1>Errors</h1>
      <div id="error"></div>
    </div>
    <script>
      /**
       * @type {HTMLVideoElement}
       */
      let video = document.querySelector("#stream");
      /**
       * @type {HTMLDivElement}
       */
      let error = document.querySelector("#error");
      /**
       * @type {HTMLDivElement}
       */
      let output = document.querySelector("#output");
      function checkRequirements() {
        if (!navigator.mediaDevices?.getUserMedia) {
          return "Browser not supported";
        }

        return true;
      }

      /**
       * @param {HTMLVideoElement} video
       */
      function start() {
        if (checkRequirements() !== true) {
          error.innerText = checkRequirements();
          return;
        }

        const detector = new BarcodeDetector({
          formats: ["qr_code"],
        });

        navigator.mediaDevices
          .getUserMedia({
            video: { facingMode: { ideal: "environment" } },
            audio: false,
          })
          .then((s) => {
            video.srcObject = s;
            video.play();
            scanAgain();
          });

        window.setInterval(() => {
          if (state.scanned) return;
          detector.detect(video).then(onScanSuccess).catch(onScanFailure);
        }, 100);
      }

      /**
       * @param {string} url
       * @returns {null|URL}
       */
      function URLFilter(url) {
        let temp;
        try {
          temp = new URL(url);
        } catch (_) {
          return null;
        }
        if (
          !(
            temp.href.startsWith("upi://pay?") &&
            temp.searchParams.has("pa") &&
            temp.searchParams.has("pn")
          )
        ) {
          return null;
        }
        return temp;
      }
      function onScanSuccess(qrcodes) {
        let url;
        for (const qr of qrcodes) {
          url = URLFilter(qr.rawValue);
          if (url === null) continue;

          console.log(url.href);
          state.scanned = true;
          state.upi = url.href;

          output.innerHTML = state.upi;
          break;
        }
      }
      function onScanFailure(err) {
        error.innerHTML = err;
      }

      start();
    </script>
  </body>
</html>
