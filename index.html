<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPI</title>
    <script>
      /**
       * @type {boolean}
       */
      let isScanned = false;

      function scanAgain() {
        isScanned = false;
      }
    </script>
  </head>
  <body>
    <h1>Hi</h1>
    <video id="stream" style="width: 75vw; height: 75vh">Why</video>
    <button type="button" onclick="scanAgain()">Scan Again</button>
    <div id="error"></div>
    <div id="output"></div>
    <div><ul id="logs"></ul></div>
    <script>
      /**
       * @type {HTMLVideoElement}
       */
      let video = document.querySelector("#stream");
      /**
       * @type {HTMLDivElement}
       */
      let error = document.querySelector("#error");
      /**
       * @type {HTMLDivElement}
       */
      let output = document.querySelector("#output");
      /**
       * @type {HTMLUListElement}
       */
      let log = document.querySelector("#logs");

      function logger(string) {
        log.innerHTML += `<li>${string}</li>`;
      }

      const stream = navigator.mediaDevices
        .getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false,
        })
        .then((stream) => {
          video.srcObject = stream;
          video.play();
        });

      if (!("BarcodeDetector" in globalThis)) {
        error.innerText = "Barcode Detector is not supported by this browser.";
      } else {
        const barcodeDetector = new BarcodeDetector({
          formats: ["qr_code"],
        });

        setInterval(async () => {
          if (isScanned) return;
          try {
            const barcodes = await barcodeDetector.detect(video);
            let string = "<ul>";
            for (let index = 0; index < barcodes.length; index++) {
              string =
                string +
                "<li>" +
                barcodes[index].rawValue +
                JSON.stringify(barcodes[index]) +
                "</li>";
            }
            string = string + "</ul>";
            output.innerHTML = string;
          } catch (err) {
            error.innerText = err;
          }
        }, 100);
      }
    </script>
  </body>
</html>
